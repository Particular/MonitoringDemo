name: Check Platform Sample Dependencies
on:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * 1-5' # Hourly, Monday-Friday
defaults:
  run:
    shell: pwsh
jobs:
  check:
    name: Check dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Download deployed dependencies
        run: |
          $url = "https://s3.amazonaws.com/particular.downloads/MonitoringDemo/Particular.MonitoringDemo.dependencies.json"
          echo "Getting currently-deployed dependencies from $url"
          $current = (Invoke-WebRequest $url).Content | ConvertFrom-Json
          echo $current | ConvertTo-Json

          echo "Getting most recent versions from NuGet"
          $serviceControl = Find-Package Particular.PlatformSample.ServiceControl
          $servicePulse = Find-Package Particular.PlatformSample.ServicePulse
          $platformSample = Find-Package Particular.PlatformSample

          $latest = @{
            PlatformSample = $platformSample.Version
            ServiceControl = $serviceControl.Version
            ServicePulse = $servicePulse.Version
          }
          echo $latest | ConvertTo-Json

          $upToDate = $true
          if ($current.PlatformSample -ne $latest.PlatformSample) {
            echo "PlatformSample version does not match"
            $upToDate = $false
          }
          if ($current.ServiceControl -ne $latest.ServiceControl) {
            echo "ServiceControl version does not match"
            $upToDate = $false
          }
          if ($current.ServicePulse -ne $latest.ServicePulse) {
            echo "ServicePulse version does not match"
            $upToDate = $false
          }

          if ($upToDate) {
            echo "Everything is up-to-date, nothing to do"
            gh workflow run release.yml
          } else {
            echo "Updates are needed, should invoke release workflow"
          }